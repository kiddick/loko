{% load jsonify %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
        crossorigin="anonymous"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.8/css/AdminLTE.css"> -->

    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/bower_components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/dist/css/skins/_all-skins.min.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/css/select2.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script> -->
    <title>Loko</title>
</head>

<body>
    <section class="content">
        <div class="row">
            <div class="col-md-4">
                <div id="main" class="box box-primary">
                    <form action="/calc" method="GET">
                        <div class="box-header">
                            <h1>Локо аналитика</h1>
                        </div>

                        <div class="form-group">
                            <label for="lquery">Филиалы и серии:</label>
                            <input id="lquery" value="" style="width:300px;" name="lquery">
                        </div>
                        <div class="form-group">
                            <label for="kmFrom">Начало:</label>
                            <select name="kmfrom" class="form-control" id="kmfrom">
                                {% for km in kms %}
                                <option>{{km}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kmTo">Конец:</label>
                            <select name="kmto" class="form-control" id="kmto">
                                {% for km in kms %}
                                <option>{{km}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="submitbtn">
                            <input type="submit" value="Submit" class="btn btn-primary">
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-md-4">
                <div id="lchart" class="box box-primary">
                    <div class="box-header">
                        <h2>chart</h2>
                    </div>
                    <p>query: {{lquery}}</p>
                    <p>from: {{kmfrom}}</p>
                    <p>to: {{kmto}}</p>

                    <canvas id="myChart" width="400" height="400">
                    </canvas>
                </div>
            </div>
        </div>
        </div>
    </section>

    <script>
        var ctx = document.getElementById("myChart");
        var myChart = new Chart(ctx, {
            type: 'bar',
            // data: {{ chart|jsonify }},
            data: {
                labels: {{ chart_labels|jsonify }},
                datasets: [{
                    label: 'Выручка',
                    data: {{ chart_data|jsonify }},
                    borderWidth: 2,
                    backgroundColor: "#e8c3b9"
                    // backgroundColor: "#FF6384"
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    </script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.js"></script>
    <!-- <script>
        $('.select2').select2()
    </script> -->
    <script>
        Array.prototype.diff = function (a) {
            return this.filter(function (i) { return a.indexOf(i) < 0; });
        };

        var ldata = {{ loko_data| jsonify }};
        // console.log(FRUIT_GROUPS)
        // console.log(JSON.stringify(FRUIT_GROUPS))
        // var ffs = [
        //     {
        //         id: '',
        //         text: 'Citrus',
        //         children: [
        //             { id: 'c1', text: 'Grapefruit' },
        //             { id: 'c2', text: 'Orange' },
        //             { id: 'c3', text: 'Lemon' },
        //             { id: 'c4', text: 'Lime' }
        //         ]
        //     },
        //     {
        //         id: '',
        //         text: 'Other',
        //         children: [
        //             { id: 'o1', text: 'Apple' },
        //             { id: 'o2', text: 'Mango' },
        //             { id: 'o3', text: 'Banana' }
        //         ]
        //     }
        // ];
        // console.log(JSON.stringify(ffs))
        // console.log(ffs)
        // var FRUIT_GROUPS = ffs;
        // selected ids -->
        $('#lquery').select2({
            multiple: true,
            placeholder: "Выберите..",
            data: ldata,
            query: function (options) {
                var selectedItems = options.element.select2('data');
                var selectedIds = options.element.select2('val');
                var selectableGroups = $.map(this.data, function (group) {
                    var areChildrenAllSelected = true;
                    $.each(group.children, function (i, child) {
                        if (selectedIds.indexOf(child.id) < 0) {
                            areChildrenAllSelected = false;
                            return false;
                        }
                    });
                    if (areChildrenAllSelected) {
                        var childrens = group.children.map(function (item) { return item.id })
                        selectedIds = selectedIds.diff(group.children.map(function (item) { return item.id }))
                        selectedIds.push(group.id)
                        for (children of group.children) {
                            if ('shadow' in children) { children.text = children.shadow }
                            var i = selectedItems.length;
                            while (i--) {
                                if (selectedItems[i].id == children.id) {
                                    selectedItems.splice(i)
                                }
                            }
                        }
                        selectedItems.push(group)
                    }
                    if (selectedIds.includes(group.id.toString())) {
                        selectedIds = selectedIds.diff(group.children.map(function (item) { return item.id }))
                        for (children of group.children) {
                            if ('shadow' in children) { children.text = children.shadow }
                            var i = selectedItems.length;
                            while (i--) {
                                if (selectedItems[i].id == children.id) {
                                    selectedItems.splice(i, 1)
                                }
                            }
                        }
                    }
                    return !areChildrenAllSelected ? group : null;
                });
                options.element.select2('data', selectedItems)
                options.callback({ results: selectableGroups });
            }
        }).on('change.select2', function (e) {
            if ('removed' in e) {
                if ('shadow' in e.removed) {
                    e.removed.text = e.removed.shadow
                }
            }
        }).on('select2-selecting', function (e) {
            var $select = $(this);
            if ('name' in e.choice) {
                if (e.choice.text != e.choice.name) {
                    e.choice.shadow = e.choice.text;
                    e.choice.text = e.choice.name;
                }
            }
            if (e.val == '') {
                e.preventDefault();
                $select.select2('data', $select.select2('data').concat(e.choice.children));
                $select.select2('close');
            }
        });
    </script>
</body>


</html>